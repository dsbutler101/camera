
resources:
- name: {{ properties["BUCKET_NAME"] }}
  type: gcp-types/storage-v1:buckets
  properties:
    predefinedAcl: projectPrivate
    projection: full
    location: EU
    storageClass: STANDARD
    defaultObjectAcl:
      - entity: project-editors-{{ env["project_number"] }}
        role: READER
    lifecycle:
      rule:
        - action:
            type: Delete
          condition:
            age: 30
            isLive: true
    versioning:
      enabled: false

- name: camera
  type: bigquery.v2.dataset
  properties:
    datasetReference:
      datasetId: camera

- name: events
  type: bigquery.v2.table
  properties:
    datasetId: $(ref.camera.datasetReference.datasetId)
    tableReference:
      tableId: events

- name: camera-events
  type: pubsub.v1.topic
  properties:
    topic: camera-events
     
- name: facial_recognition
  type: cloud_function.py
  properties:
    codeLocation: functions/facial_recognition/
    codeBucket: {{ properties["BUCKET_NAME"] }}
    codeBucketObject: facial_recognition.zip
    location: europe-west1
    timeout: 60s
    entryPoint: handler
    availableMemoryMb: 128
    environmentVariables:
       SEND_GRID_API_KEY: {{ properties["SEND_GRID_API_KEY"] }}
       SEND_GRID_DOMAIN: {{ properties["SEND_GRID_DOMAIN"] }}
    runtime: python37
    eventTrigger:
      resource: projects/{{ env['project'] }}/buckets/{{ properties["BUCKET_NAME"] }}
      eventType: providers/cloud.storage/eventTypes/object.change

- name: pubsub_to_bigquery
  type: cloud_function.py
  properties:
    codeLocation: functions/facial_recognition/
    codeBucket: {{ properties["BUCKET_NAME"] }}
    codeBucketObject: facial_recognition.zip
    location: europe-west1
    timeout: 60s
    entryPoint: handler
    availableMemoryMb: 128
    environmentVariables:
       BIGQUERY_DATASET_ID: $(ref.camera.datasetReference.datasetId)
       BIGQUERY_TABLE_ID: $(ref.events.tableReference.tableId)
    runtime: python37
    eventTrigger:
       resource: $(ref.camera-events.name)
       eventType: providers/cloud.pubsub/eventTypes/topic.publish
